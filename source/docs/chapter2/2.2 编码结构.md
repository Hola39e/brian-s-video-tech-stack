# 编码结构
 
## 编码结构概述
 
### GOP类型
 
**开放式GOP**
 
开放式GOP就是只有第一个GOP的第一个帧内编码图像为IDR图像，后续GOP中的第一个**帧内编码**图像为non-IDR帧，也就是说，后面GOP 中的帧间编码图像可以越过non-IDR图像，使用前一个GOP 中的已编码图像做参考图像。
 
**封闭式GOP**
 
封闭式GOP就是每个GOP以IDR帧（Instantaneous Decoding Refresh）开始，所有GOP之间是独立编解码的。
 
### 简单的结构关系
 
GOP被划分为多个slice，每个slice又可以划分为多个SS（Slice Segment），同时还引入了树形结构单元CTU单元（Coding Tree Unit）,每个CTU包括了一个亮度CTB，和两个色差CTB，CTB是Coding Tree Block。
 
划分结构如图
 
### 分层结构
GOP层，Slice层中共用的大部分语法元素游离出来组成序列参数集SPS（Sequence Parameter Set）和图像参数集PPS（Picture Parameter Set）。
 
**SPS序列参数集**
SPS 的内容大致包括解码相关信息，如档次级别、分辨率、某档次中编码工具开关标识和涉及的参数、时域可分级信息等。SPS中包含了一个CVS（Coded Video Sequence）
 
**PPS图像参数集**
PPS 包含一幅图像所用的公共参数，即一幅图像中所有SS 引用同一个PPS。其大
致内容包括初始图像控制信息，如初始量化参数（Quantization Parameter，
QP）、分块信息等。
 
**VPS视频参数集**
VPS内容大致包括多个子层共享的语法元素，其他不属于SPS的特定信息等。
 
而对于SS的引用信息而言，一个SS引用自己所使用的PPS，该PPS又引用其对应的SPS，SPS又引用对应的VPS，最终得到SS的公用信息。
 

**参数集是一个独立的数据单位，它包含视频的不同层级编码单元的共享信息，只有当参数集直接或间接被SS 引用时才有效。** 同一个VPS或SPS可以被多个CVS引用，同一个PPS可以被多个图像引用。
 
在H.265/HEVC中，NAL单元根据是否装载视频编码数据被分为VCLU（Video Coding Layer NAL Unit）和non-VCLU。非编码数据的参数集作为non-VCLU 进行传输，这为传递关键数据提供了高鲁棒机制。参数集的独立使得其可以提前发送，也可以在需要增加新参数集的时候再发送，可以被多次重发或者采用特殊技术加以保护。
 
片段SS是视频编码数据的基本单位，一个SS的压缩数据生成一个VCLU进行传输。最终，一个视频序列的编码码流由一系列SS所生成的多个VCLU单元和夹杂其间的一些分割标示数据和参数集数据组成。分割标示数据用于区分一个SS 属于哪幅图像、哪个CVS。
 
## 视频参数集 VPS
 
一个给定的视频序列，无论它每一层的SPS是否相同，都参考相同的VPS。VPS包含的信息有：
- 多个子层和操作点共享的语法元素
- 会话所需的有关操作点的关键信息，如档次，级别
- 其他不属于SPS 的操作点特性信息，例如与多层或子层相关的虚拟参考解码器（Hypothetical Reference Decoder，HRD）参数。
 
## 序列参数及 SPS
 
## 图像参数及 PPS
 
## 片段层 Slice and SS
 
一幅图像可以被分割为一个或多个片（Slice），每个片的压缩数据都是独立的，Slice头信息无法通过前一个Slice的头信息推断得到，因此要求slice**不能跨过它的边界**来进行帧内或者帧间的预测，且在熵解码前幼进行初始化。但在进行环路滤波时，允许滤波器跨越slice边界进行滤波。
 
**slice的优势**
 
Slice 的解码过程可以不使用任何来自其他Slice 的影响，且有利于实现并行运算。使用Slice的主要目的是当数据丢失后能再次保证解码同步。
 
**slice的种类**
 
- I slice： 该slice中所有CU的编码过程都使用帧内预测
- P slice：在I Slice的基础上，该Slice中的CU还可以使用帧间预测，每个预测块（PB）使用至多一个运动补偿预测信息。P Slice只使用图像参考列表list 0。
- B slice：Slice：在P Slice 的基础上，B Slice 中的CU也可以使用帧间预测，但是每个PB可以使用至多两个运动补偿预测信息。B Slice可以使
用图像参考列表list 0 和list 1。
 
**slice与SS**
 
一个独立的slice可以被进一步划分为若干个SS，包括一个独立SS和所干个依赖SS，并以独立SS作为slice的开始。一个SS包含整数个CTU（至少一个），并且这些CTU分布在同一个NAL单元中。SS可以作为一个分组来传送视频编码数据。
 
其中，独立SS是指它所设计的句法元素可以由自身来确定，依赖SS是指它所涉及的某些句法元素由已经解码的独立SS推导得到。依赖SS可以共享独立SS携带的一些信息，例如RPS 信息、SAO 的可用性和加权预测的可用性等。预测过程不能跨越独立Slice 的边界，但是可以跨越依赖SS的边界，一个Slice内的SS之间可以相互参考。
 
H.265/HEVC 编码的最高层为SS层，SS层所需要的图像层信息可以通过引用相应的PPS 来获得。SS头包含其引用的PPS的标识号，同一幅图像中的所有SS 引用同一个PPS。此外，SS 头中会存在一些与PPS中相同的参数，SS头中的这些参数值会对PPS中的该参数值进行覆盖。
 
## tile单元
 
### tile单元的优势
目的是在增强并行处理能力的同时又不引入新的错误扩散。Tile提供比CTB更大程度的并行（在图像或者子图像的层面上），在使用时无须进行复杂的线程同步。
 
在编码时，图像中的所有Tile按照扫描顺序进行处理，每个Tile中的CTU也按照扫描顺序进行编码（Raster scan）。
 
### slice与tile
Tile 形状基本上为矩形，Slice的形状则为条带状。Slice由一系列的SS组成，一个SS由一系列的CTU组成。Tile则直接由一系列的CTU组成。
 

每个Slice/SS和Tile至少要满足以下两个条件之一。
- 一个slice/ss中所有的CTU都属于一个tile
- 一个tile中所有的CTU都属于同一个slice/ss
 
## 树形编码块
 
H.265/HEVC 标准中引入了树形编码单元CTU，其尺寸由编码器指定，且可大于宏块尺寸。同一位置处的一个亮度CTB和两个色度CTB，再加上相应的语法元素形成一个CTU。
 
对于一个大小为LxL的亮度CTB，L的取值可以是16、32、64。使用较大的CTB可以获得更好的压缩性能。
 
**语法单元**
H.265/HEVC 为图像划分定义了一套全新的语法单元，包括编码单元CU、预测单元（Prediction Unit，PU）和变换单元（Transform Unit，TU）。
 
编码单元是进行预测、变换、量化和熵编码等处理的基本单元，预测单元是进行帧内/帧间预测的基本单元，变换单元是进行变换和量化的基本单元。
 
### 编码单元CU
 

### 预测单元PU
 
预测单元PU规定了编码单元的所有预测模式，一切与预测有关的信息都定义在预测单元部分。比如，帧内预测的方向、帧间预测的分割方式、运动矢量预测，以及帧间预测参考图像索引号都属于预测单元的范畴。
 
**PU的划分模式**
 
一个2Nx2N的编码单元所包含的预测单元划分模式如下，对于一个2Nx2N的CU模式，帧内预测单元PU可选模式有两种：
- 2Nx2N
- NxN
 
帧间预测单元PU的可选模式有8种：
 
四种对称模式：
- 2Nx2N，2NxN，Nx2N, NxN
 
四种非对称模式：
- 2NxnU，2NxnD，nLx2N，nRx2N
 
其中2N×nU 和2N×nD 分别以上下1:3、3:1 的比率划分，nL×2N 和nR×2N 分别以左右1:3、3:1 的比率划分。
 
skip模式是帧间预测的一种，当需要编码的运动信息只有运动参数集索引（采用运动合并技术），编码残差信息不需要编码时，为2N×2Nskip模式。
 
### 变换单元TU
H.265/HEVC 突破了原有的变换尺寸限制，可支持大小为4×4～32×32的编码变换，以变换单元（TU）为基本单元进行变换和量化。它的大小依赖于CU 模式，在一个CU 内，允许TU 跨越多个PU，以四叉树的形式递归划分。
 
对于一个2N×2N的CU，有一个标志位决定其是否划分为4个N×N的TU，是否可以进一步划分由SPS 中的TU 的最大划分深度决定。
 
**TU划分深度的优势**
 
根据预测残差的局部变化特性，TU可以自适应地选择最优的模式。大块的TU模式能够将能量更好地集中，小块的TU模式能够保存更多的图像细节。这种灵活的分割结构，可以使变换后的残差能量得到充分压缩.
 
## Profile,Level and Tier